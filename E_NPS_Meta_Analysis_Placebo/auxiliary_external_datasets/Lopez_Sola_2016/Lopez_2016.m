%% Lopez-Sola et al. 2017: Nailbed Pressure Pain


%% Import data from data struct supplied by Lopez-Sola et al. 
load('../../../../Datasets_for_NPS_effect_size_comparison/2016_Marina_FMstudy_PRESSUREPAIN/results/image_names_and_setup.mat');

NPS4pt5=DAT.SIG_conditions.raw.dotproduct.NPS.Controls_4pt5_kgPress;
NPS6=DAT.SIG_conditions.raw.dotproduct.NPS.Controls_6_kgPress;
SIIPS4pt5=DAT.SIG_conditions.raw.dotproduct.SIIPS.Controls_4pt5_kgPress;
SIIPS6=DAT.SIG_conditions.raw.dotproduct.SIIPS.Controls_6_kgPress;

rating6=xlsread('../../../../Datasets_for_NPS_effect_size_comparison/2016_Marina_FMstudy_PRESSUREPAIN/data/ControlsFM_PainRatings.xlsx','B2:B30');
rating4pt5=xlsread('../../../../Datasets_for_NPS_effect_size_comparison/2016_Marina_FMstudy_PRESSUREPAIN/data/ControlsFM_PainRatings.xlsx','D2:D30');

%% Calculate MetaStats

pressure_steps={
           '4.5 vs 6.0 kg/cm^2'
           };

       
lopez_stats.nps=withinMetastats(NPS4pt5,NPS6);
lopez_stats.rating=withinMetastats(rating4pt5,rating6);

%% Forest plots for ratings and NPS
% Do not calculate random-effects GIV summary... all conditions are from
% the same study, therefore this is not the appropriate model!
ForestPlotter(lopez_stats.rating,...
                  'studyIDtexts',pressure_steps,...
                  'outcomelabel','Rating difference (Hedges'' g)',...
                  'type','random',...
                  'summarystat','g',...
                  'withoutlier',0,...
                  'WIsubdata',0,...
                  'boxscaling',1,...
                  'textoffset',0,...
                  'NOsummary',1,...
                  'Xscale',2);
hgexport(gcf, 'Lopez_Sola_2016_Rating.svg', hgexport('factorystyle'), 'Format', 'svg');
hgexport(gcf, 'Lopez_Sola_2016_Rating.png', hgexport('factorystyle'), 'Format', 'png'); 
crop('Lopez_Sola_2016_Rating.png');

ForestPlotter([lopez_stats.nps],...
                  'studyIDtexts',pressure_steps,...
                  'outcomelabel','NPS difference (Hedges'' g)',...
                  'type','random',...
                  'summarystat','g',...
                  'withoutlier',0,...
                  'WIsubdata',0,...
                  'boxscaling',1,...
                  'textoffset',0,...
                  'NOsummary',1,...
                  'Xscale',2);
hgexport(gcf, 'Lopez_Sola_2016_NPS.svg', hgexport('factorystyle'), 'Format', 'svg');
hgexport(gcf, 'Lopez_Sola_2016_NPS.png', hgexport('factorystyle'), 'Format', 'png'); 
crop('Lopez_Sola_2016_NPS.png');

%% Print results as txt
ciLo=lopez_stats.nps.g+1.96*lopez_stats.nps.se_g;
ciHi=lopez_stats.nps.g-1.96*lopez_stats.nps.se_g;
sprintf(['Effect Size (Hedge''s g) of nailbed pressure difference 6 vs 4.5 km/cm^2 on NPS: ',...
        '%0.3g 95%% CI [%0.3g, %0.3g]'],lopez_stats.nps.g,ciLo,ciHi)
ciLo=lopez_stats.rating.g+1.96*lopez_stats.rating.se_g;
ciHi=lopez_stats.rating.g-1.96*lopez_stats.rating.se_g;
sprintf(['Effect Size (Hedge''s g) of nailbed pressure difference 6 vs 4.5 km/cm^2 on Ratings: ',...
        '%0.3g 95%% CI [%0.3g, %0.3g]'],lopez_stats.rating.g,ciLo,ciHi)

corrcoef(lopez_stats.rating.std_delta,lopez_stats.nps.std_delta)